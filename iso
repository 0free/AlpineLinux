#!/bin/bash

clear && cd ~

if [[ -f /lib/apk/db/lock ]]; then
   sudo rm /lib/apk/db/lock
fi

sudo apk cache
sudo apk update
sudo apk upgrade
sudo apk add build-base busybox fakeroot syslinux xorriso squashfs-tools git
sudo apk add alpine-sdk apk-tools alpine-conf
sudo apk add mtools dosfstools grub-efi

USER=$(whoami)

sudo usermod -a -G abuild $USER

if [[ ! -d ./.abuild ]]; then
   echo -en '\n' | abuild-keygen -i -a
fi

if [[ ! -d ./aports ]]; then
   git clone https://gitlab.alpinelinux.org/alpine/aports.git
else
   cd ./aports
   git pull
   cd ..
fi

cat << EOF > ./aports/scripts/mkimg.iso.sh
profile_iso() {

   arch="x86_64"
   output_format="iso"
   image_ext="iso"

   profile_standard

   boot_addons="amd-ucode intel-ucode"

   initrd_ucode="/boot/amd-ucode.img /boot/intel-ucode.img"

   apks="\$apks
         linux-lts linux-firmware
         alpine-base busybox kbd-bkeymaps chrony dhcpcd
         coreutils ethtool hwids doas
         iwd wireless-tools wpa_supplicant
         iscsi-scst cciss_vol_status lvm2 mdadm
         mkinitfs util-linux
         ca-certificates curl wget rsync nano
         syslinux
         e2fsprogs e2fsprogs-extra
         mtools dosfstools nfs-utils ntfs-3g btrfs-progs xfsprogs f2fs-tools
         zfs zfs-openrc zfs-scripts zfs-utils-py
         parted sfdisk sgdisk
         "

}
EOF

chmod +x ./aports/scripts/mkimg.iso.sh

if [[ -d ./alpine ]]; then
   sudo rm -rf ./alpine
fi

mkdir ./alpine

sh ./aports/scripts/mkimage.sh \
--profile iso \
--outdir ./ \
--workdir ./alpine \
--repository https://dl-cdn.alpinelinux.org/alpine/edge/main \
--repository https://dl-cdn.alpinelinux.org/alpine/edge/community \
--repository https://dl-cdn.alpinelinux.org/alpine/edge/testing

#end
